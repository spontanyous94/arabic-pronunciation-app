<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic Pronunciation Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border: none;
            background: none;
            font-size: 1rem;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        /* Data persistence notice */
        .data-notice {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            border-left: 4px solid #6c5700;
        }

        .data-notice h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .backup-controls {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-controls h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Arial', sans-serif;
            direction: rtl;
            text-align: right;
            font-size: 1.2rem;
            line-height: 1.8;
        }

        .english-textarea {
            direction: ltr;
            text-align: left;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .recording-timer {
            background: #ff6b6b;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            animation: pulse 1.5s infinite;
        }

        .status {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            display: inline-block;
            margin-top: 15px;
        }

        .status.recording {
            background: #ffe3e3;
            color: #d63384;
            animation: pulse 1.5s infinite;
        }

        .status.ready {
            background: #d4edda;
            color: #155724;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .exercise-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .exercise-card:hover {
            border-color: #4facfe;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .exercise-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            direction: rtl;
            text-align: right;
            font-size: 1.3rem;
            line-height: 2;
            font-family: 'Arial', sans-serif;
            border-left: 4px solid #4facfe;
        }

        .exercise-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .difficulty {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty.beginner {
            background: #d4edda;
            color: #155724;
        }

        .difficulty.intermediate {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty.advanced {
            background: #f8d7da;
            color: #721c24;
        }

        .submission-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .audio-player {
            width: 100%;
            margin: 15px 0;
            border-radius: 10px;
        }

        .submissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .submission-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .submission-card:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .student-name {
            font-weight: 600;
            color: #333;
        }

        .timestamp {
            font-size: 0.85rem;
            color: #666;
        }

        .feedback-form {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .feedback-form textarea {
            min-height: 80px;
            direction: ltr;
            text-align: left;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .rating-group select {
            width: auto;
            min-width: 120px;
        }

        .share-link-container {
            background: #f0f8ff;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .share-link {
            background: white;
            border: 2px solid #4facfe;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #333;
            word-break: break-all;
            margin: 10px 0;
            display: block;
            text-decoration: none;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .copy-btn.copied {
            background: #6c757d;
        }

        .exercise-management-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .exercise-management-card:hover {
            border-color: #4facfe;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .student-view-notice {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .student-view-notice h3 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
        }

        .search-filter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-filter input {
            flex: 1;
            min-width: 200px;
        }

        .search-filter select {
            width: auto;
            min-width: 150px;
        }

        .stats-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .recording-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .exercise-meta {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .submissions-grid {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .backup-buttons {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #4facfe;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Form validation styles */
        .invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
        }

        /* Progress indicators */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Arabic Pronunciation Practice</h1>
            <p>Upload exercises and review student pronunciation recordings</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('teacher')">Teacher Portal</button>
            <button class="tab" onclick="switchTab('student')">Student Practice</button>
            <button class="tab" onclick="switchTab('review')">Review Submissions</button>
        </div>

        <!-- Teacher Portal -->
        <div id="teacher" class="tab-content active">
            <!-- Data Notice -->
            <div class="data-notice">
                <h4>‚ö†Ô∏è Important Notice</h4>
                <p>This app stores data locally in your browser. Please regularly backup your data to avoid losing exercises and submissions if you clear browser data or switch devices.</p>
            </div>

            <!-- Backup Controls -->
            <div class="backup-controls">
                <h3>üìÅ Data Management</h3>
                <div class="backup-buttons">
                    <button class="btn btn-secondary" onclick="exportData()">
                        üíæ Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                        üìÅ Import Data
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>

            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>
            
            <h2 style="margin-bottom: 25px; color: #333;">Create New Exercise</h2>
            
            <form id="exerciseForm">
                <div class="form-group">
                    <label for="exerciseTitle">Exercise Title *</label>
                    <input type="text" id="exerciseTitle" placeholder="Enter exercise title" required>
                    <div class="error-message" id="titleError"></div>
                </div>

                <div class="form-group">
                    <label for="arabicText">Arabic Text *</label>
                    <textarea id="arabicText" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÜÿµ ÿßŸÑÿπÿ±ÿ®Ÿä ŸáŸÜÿß..." required></textarea>
                    <div class="error-message" id="arabicError"></div>
                </div>

                <div class="form-group">
                    <label for="transliteration">Transliteration (Optional)</label>
                    <textarea id="transliteration" class="english-textarea" placeholder="Enter transliteration..."></textarea>
                </div>

                <div class="form-group">
                    <label for="translation">Translation (Optional)</label>
                    <textarea id="translation" class="english-textarea" placeholder="Enter English translation..."></textarea>
                </div>

                <div class="form-group">
                    <label for="difficulty">Difficulty Level *</label>
                    <select id="difficulty" required>
                        <option value="">Select difficulty</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                    <div class="error-message" id="difficultyError"></div>
                </div>

                <button type="submit" class="btn">
                    üìù Create Exercise
                </button>
            </form>

            <div id="exerciseSuccess" class="status ready" style="display: none;">
                Exercise created successfully!
            </div>

            <!-- Existing Exercises Management -->
            <div id="exercisesManagement" style="margin-top: 40px;">
                <h2 style="margin-bottom: 25px; color: #333;">Manage Exercises</h2>
                
                <!-- Search and Filter -->
                <div class="search-filter">
                    <input type="text" id="exerciseSearch" placeholder="Search exercises..." onkeyup="filterExercises()">
                    <select id="difficultyFilter" onchange="filterExercises()">
                        <option value="">All Difficulties</option>
                        <option value="beginner">Beginner</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
                
                <div id="teacherExercisesList">
                    <!-- Teacher's exercises will be populated here -->
                </div>
            </div>
        </div>

        <!-- Student Practice -->
        <div id="student" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #333;">Practice Exercises</h2>
            
            <!-- Search and Filter for Students -->
            <div class="search-filter">
                <input type="text" id="studentExerciseSearch" placeholder="Search exercises..." onkeyup="filterStudentExercises()">
                <select id="studentDifficultyFilter" onchange="filterStudentExercises()">
                    <option value="">All Difficulties</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
            
            <div id="exercisesList">
                <!-- Exercises will be populated here -->
            </div>
        </div>

        <!-- Review Submissions -->
        <div id="review" class="tab-content">
            <h2 style="margin-bottom: 25px; color: #333;">Student Submissions</h2>
            
            <!-- Search and Filter for Submissions -->
            <div class="search-filter">
                <input type="text" id="submissionSearch" placeholder="Search by student name..." onkeyup="filterSubmissions()">
                <select id="ratingFilter" onchange="filterSubmissions()">
                    <option value="">All Ratings</option>
                    <option value="excellent">Excellent</option>
                    <option value="good">Good</option>
                    <option value="needs-improvement">Needs Improvement</option>
                    <option value="unrated">Unrated</option>
                </select>
            </div>
            
            <div id="submissionsList" class="submissions-grid">
                <!-- Submissions will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let exercises = [];
        let submissions = [];
        let currentRecording = null;
        let mediaRecorder = null;
        let recordingTimer = null;
        let recordingStartTime = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            displayExercises();
            displaySubmissions();
            displayTeacherExercises();
            displayStats();
            checkForDirectExercise();
            
            document.getElementById('exerciseForm').addEventListener('submit', createExercise);
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Update stats when switching to teacher tab
            if (tabName === 'teacher') {
                displayStats();
            }
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            const title = document.getElementById('exerciseTitle').value.trim();
            const arabicText = document.getElementById('arabicText').value.trim();
            const difficulty = document.getElementById('difficulty').value;

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('input, textarea, select').forEach(el => el.classList.remove('invalid'));

            if (!title) {
                document.getElementById('titleError').textContent = 'Title is required';
                document.getElementById('exerciseTitle').classList.add('invalid');
                isValid = false;
            }

            if (!arabicText) {
                document.getElementById('arabicError').textContent = 'Arabic text is required';
                document.getElementById('arabicText').classList.add('invalid');
                isValid = false;
            }

            if (!difficulty) {
                document.getElementById('difficultyError').textContent = 'Difficulty level is required';
                document.getElementById('difficulty').classList.add('invalid');
                isValid = false;
            }

            return isValid;
        }

        // Create new exercise with validation
        function createExercise(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const exercise = {
                id: Date.now(),
                title: document.getElementById('exerciseTitle').value.trim(),
                arabicText: document.getElementById('arabicText').value.trim(),
                transliteration: document.getElementById('transliteration').value.trim(),
                translation: document.getElementById('translation').value.trim(),
                difficulty: document.getElementById('difficulty').value,
                createdAt: new Date().toISOString()
            };
            
            exercises.push(exercise);
            saveData();
            displayExercises();
            displayTeacherExercises();
            displayStats();
            
            // Reset form
            document.getElementById('exerciseForm').reset();
            
            // Show success message
            showSuccessMessage('Exercise created successfully!');
        }

        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.getElementById('exerciseSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Display statistics
        function displayStats() {
            const container = document.getElementById('statsGrid');
            const totalExercises = exercises.length;
            const totalSubmissions = submissions.length;
            const uniqueStudents = new Set(submissions.map(s => s.studentName)).size;
            const pendingReviews = submissions.filter(s => !s.rating).length;

            container.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalExercises}</div>
                    <div class="stat-label">Total Exercises</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${totalSubmissions}</div>
                    <div class="stat-label">Total Submissions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${uniqueStudents}</div>
                    <div class="stat-label">Unique Students</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${pendingReviews}</div>
                    <div class="stat-label">Pending Reviews</div>
                </div>
            `;
        }

        // Data management functions
        function exportData() {
            const data = {
                exercises: exercises,
                submissions: submissions.map(sub => ({
                    ...sub,
                    audioUrl: null // Don't export audio URLs as they're temporary
                })),
                exportDate: new Date().toISOString(),
                version: "1.0"
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `arabic-pronunciation-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage('Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all existing data. Are you sure?')) {
                        exercises = data.exercises || [];
                        submissions = data.submissions || [];
                        
                        saveData();
                        displayExercises();
                        displaySubmissions();
                        displayTeacherExercises();
                        displayStats();
                        
                        showSuccessMessage('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('This will permanently delete all exercises and submissions. Are you sure?')) {
                if (confirm('This action cannot be undone. Please confirm again.')) {
                    exercises = [];
                    submissions = [];
                    localStorage.removeItem('arabicPronunciationData');
                    
                    displayExercises();
                    displaySubmissions();
                    displayTeacherExercises();
                    displayStats();
                    
                    showSuccessMessage('All data cleared successfully!');
                }
            }
        }

        // Filter functions
        function filterExercises() {
            const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();
            const difficultyFilter = document.getElementById('difficultyFilter').value;
            
            displayTeacherExercises(searchTerm, difficultyFilter);
        }

        function filterStudentExercises() {
            const searchTerm = document.getElementById('studentExerciseSearch').value.toLowerCase();
            const difficultyFilter = document.getElementById('studentDifficultyFilter').value;
            
            displayExercises(searchTerm, difficultyFilter);
        }

        function filterSubmissions() {
            const searchTerm = document.getElementById('submissionSearch').value.toLowerCase();
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            displaySubmissions(searchTerm, ratingFilter);
        }

        // Generate shareable link for exercise
        function generateShareableLink(exerciseId) {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?exercise=${exerciseId}`;
        }

        // Copy link to clipboard
        async function copyToClipboard(text, buttonElement) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                }, 2000);
            }
        }

        // Display exercises for teacher management
        function displayTeacherExercises(searchTerm = '', difficultyFilter = '') {
            const container = document.getElementById('teacherExercisesList');
            
            let filteredExercises = exercises;
            
            if (searchTerm) {
                filteredExercises = filteredExercises.filter(ex => 
                    ex.title.toLowerCase().includes(searchTerm) ||
                    ex.arabicText.includes(searchTerm)
                );
            }
            
            if (difficultyFilter) {
                filteredExercises = filteredExercises.filter(ex => ex.difficulty === difficultyFilter);
            }
            
            if (filteredExercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No exercises found.</p>';
                return;
            }
            
            container.innerHTML = filteredExercises.map(exercise => {
                const shareLink = generateShareableLink(exercise.id);
                const submissionCount = submissions.filter(sub => sub.exerciseId === exercise.id).length;
                
                return `
                    <div class="exercise-management-card">
                        <div class="exercise-meta">
                            <h3>${exercise.title}</h3>
                            <span class="difficulty ${exercise.difficulty}">${exercise.difficulty}</span>
                        </div>
                        
                        <div class="exercise-text">${exercise.arabicText}</div>
                        
                        <p style="margin: 15px 0; color: #666;">
                            <strong>Submissions:</strong> ${submissionCount} student(s) have submitted recordings
                        </p>
                        
                        <div class="share-link-container">
                            <h4 style="margin-bottom: 15px; color: #333;">Share with Students</h4>
                            <p style="margin-bottom: 10px; color: #666;">Copy this link and paste it into Google Classroom, Canvas, or send directly to students:</p>
                            
                            <div class="share-link">${shareLink}</div>
                            
                            <div style="margin-top: 15px;">
                                <button class="copy-btn" onclick="copyToClipboard('${shareLink}', this)">
                                    üìã Copy Link
                                </button>
                                <button class="copy-btn" onclick="copyToClipboard('${shareLink}', this)" style="background: #6f42c1;">
                                    üìß Copy for Email
                                </button>
                            </div>
                            
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                <strong>Instructions for students:</strong><br>
                                "Click the link, enter your name, record yourself reading the Arabic text aloud, and submit your recording."
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="previewExercise(${exercise.id})">
                                üëÅÔ∏è Preview Student View
                            </button>
                            <button class="btn btn-danger" onclick="deleteExercise(${exercise.id})">
                                üóëÔ∏è Delete Exercise
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Check if URL contains direct exercise link
        function checkForDirectExercise() {
            const urlParams = new URLSearchParams(window.location.search);
            const exerciseId = urlParams.get('exercise');
            
            if (exerciseId) {
                const exercise = exercises.find(ex => ex.id == exerciseId);
                if (exercise) {
                    switchTabDirect('student');
                    displaySingleExercise(exercise);
                    
                    const studentTab = document.getElementById('student');
                    const existingNotice = studentTab.querySelector('.student-view-notice');
                    if (existingNotice) existingNotice.remove();
                    
                    studentTab.insertAdjacentHTML('afterbegin', `
                        <div class="student-view-notice">
                            <h3>üìö Assignment: ${exercise.title}</h3>
                            <p>You've been directed to a specific pronunciation exercise. Complete the recording and submit it below.</p>
                        </div>
                    `);
                }
            }
        }

        function switchTabDirect(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        // Display single exercise (for direct links)
        function displaySingleExercise(exercise) {
            const container = document.getElementById('exercisesList');
            
            container.innerHTML = `
                <div class="exercise-card">
                    <div class="exercise-meta">
                        <h3>${exercise.title}</h3>
                        <span class="difficulty ${exercise.difficulty}">${exercise.difficulty}</span>
                    </div>
                    
                    <div class="exercise-text">${exercise.arabicText}</div>
                    
                    ${exercise.transliteration ? `<p><strong>Transliteration:</strong> ${exercise.transliteration}</p>` : ''}
                    ${exercise.translation ? `<p><strong>Translation:</strong> ${exercise.translation}</p>` : ''}
                    
                    <div class="submission-form">
                        <div class="form-group">
                            <label>Student Name *</label>
                            <input type="text" id="studentName-${exercise.id}" placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Email (Optional)</label>
                            <input type="email" id="studentEmail-${exercise.id}" placeholder="Enter your email">
                        </div>
                        
                        <div class="recording-controls">
                            <button class="btn" onclick="startRecording(${exercise.id})">
                                üé§ Start Recording
                            </button>
                            <button class="btn btn-danger" onclick="stopRecording()" disabled id="stopBtn-${exercise.id}">
                                ‚èπÔ∏è Stop Recording
                            </button>
                            <span id="timer-${exercise.id}" class="recording-timer" style="display: none;">00:00</span>
                            <button class="btn btn-success" onclick="submitRecording(${exercise.id})" disabled id="submitBtn-${exercise.id}">
                                üì§ Submit Recording
                            </button>
                        </div>
                        
                        <div id="recordingStatus-${exercise.id}"></div>
                        <audio id="audioPlayer-${exercise.id}" controls style="display: none;" class="audio-player"></audio>
                    </div>
                </div>
            `;
        }

        // Preview exercise as student would see it
        function previewExercise(exerciseId) {
            const exercise = exercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;
            
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Preview: ${exercise.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                        .preview-container { background: white; padding: 30px; border-radius: 15px; }
                        .exercise-text { 
                            background: #f8f9fa; padding: 20px; border-radius: 10px; 
                            direction: rtl; text-align: right; font-size: 1.3rem; 
                            line-height: 2; border-left: 4px solid #4facfe; margin: 20px 0;
                        }
                        .difficulty { 
                            padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
                            background: #d4edda; color: #155724;
                        }
                        .notice { background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <div class="preview-container">
                        <h1>${exercise.title}</h1>
                        <span class="difficulty">${exercise.difficulty}</span>
                        
                        <div class="notice">
                            <strong>Preview Mode:</strong> This is how students will see the exercise.
                        </div>
                        
                        <div class="exercise-text">${exercise.arabicText}</div>
                        
                        ${exercise.transliteration ? `<p><strong>Transliteration:</strong> ${exercise.transliteration}</p>` : ''}
                        ${exercise.translation ? `<p><strong>Translation:</strong> ${exercise.translation}</p>` : ''}
                        
                        <div style="margin-top: 30px;">
                            <h3>Student Instructions:</h3>
                            <ol>
                                <li>Enter your name</li>
                                <li>Click "Start Recording" and read the Arabic text aloud</li>
                                <li>Click "Stop Recording" when finished</li>
                                <li>Listen to your recording to check it</li>
                                <li>Click "Submit Recording" to send it to your teacher</li>
                            </ol>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Delete exercise
        function deleteExercise(exerciseId) {
            if (confirm('Are you sure you want to delete this exercise? This will also delete all related submissions.')) {
                exercises = exercises.filter(ex => ex.id !== exerciseId);
                submissions = submissions.filter(sub => sub.exerciseId !== exerciseId);
                saveData();
                displayExercises();
                displayTeacherExercises();
                displaySubmissions();
                displayStats();
                showSuccessMessage('Exercise deleted successfully!');
            }
        }

        // Display exercises for students
        function displayExercises(searchTerm = '', difficultyFilter = '') {
            const container = document.getElementById('exercisesList');
            
            let filteredExercises = exercises;
            
            if (searchTerm) {
                filteredExercises = filteredExercises.filter(ex => 
                    ex.title.toLowerCase().includes(searchTerm) ||
                    ex.arabicText.includes(searchTerm)
                );
            }
            
            if (difficultyFilter) {
                filteredExercises = filteredExercises.filter(ex => ex.difficulty === difficultyFilter);
            }
            
            if (filteredExercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No exercises available yet.</p>';
                return;
            }
            
            container.innerHTML = filteredExercises.map(exercise => `
                <div class="exercise-card">
                    <div class="exercise-meta">
                        <h3>${exercise.title}</h3>
                        <span class="difficulty ${exercise.difficulty}">${exercise.difficulty}</span>
                    </div>
                    
                    <div class="exercise-text">${exercise.arabicText}</div>
                    
                    ${exercise.transliteration ? `<p><strong>Transliteration:</strong> ${exercise.transliteration}</p>` : ''}
                    ${exercise.translation ? `<p><strong>Translation:</strong> ${exercise.translation}</p>` : ''}
                    
                    <div class="submission-form">
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" id="studentName-${exercise.id}" placeholder="Enter your name" required>
                        </div>
                        
                        <div class="recording-controls">
                            <button class="btn" onclick="startRecording(${exercise.id})">
                                üé§ Start Recording
                            </button>
                            <button class="btn btn-danger" onclick="stopRecording()" disabled id="stopBtn-${exercise.id}">
                                ‚èπÔ∏è Stop Recording
                            </button>
                            <span id="timer-${exercise.id}" class="recording-timer" style="display: none;">00:00</span>
                            <button class="btn btn-success" onclick="submitRecording(${exercise.id})" disabled id="submitBtn-${exercise.id}">
                                üì§ Submit Recording
                            </button>
                        </div>
                        
                        <div id="recordingStatus-${exercise.id}"></div>
                        <audio id="audioPlayer-${exercise.id}" controls style="display: none;" class="audio-player"></audio>
                    </div>
                </div>
            `).join('');
        }

        // Recording functions with timer
        async function startRecording(exerciseId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audioPlayer = document.getElementById(`audioPlayer-${exerciseId}`);
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    currentRecording = { exerciseId, audioBlob, audioUrl };
                    
                    document.getElementById(`submitBtn-${exerciseId}`).disabled = false;
                    updateRecordingStatus(exerciseId, 'ready', 'Recording ready for submission');
                    
                    // Clear timer
                    if (recordingTimer) {
                        clearInterval(recordingTimer);
                        recordingTimer = null;
                    }
                    document.getElementById(`timer-${exerciseId}`).style.display = 'none';
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Update UI
                document.querySelector(`button[onclick="startRecording(${exerciseId})"]`).disabled = true;
                document.getElementById(`stopBtn-${exerciseId}`).disabled = false;
                updateRecordingStatus(exerciseId, 'recording', 'Recording in progress...');
                
                // Start timer
                const timerElement = document.getElementById(`timer-${exerciseId}`);
                timerElement.style.display = 'inline-block';
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    timerElement.textContent = `${minutes}:${seconds}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Re-enable start button for all exercises
                document.querySelectorAll('button[onclick^="startRecording"]').forEach(btn => {
                    btn.disabled = false;
                });
                
                // Disable stop buttons
                document.querySelectorAll('button[id^="stopBtn-"]').forEach(btn => {
                    btn.disabled = true;
                });
            }
        }

        function updateRecordingStatus(exerciseId, type, message) {
            const statusDiv = document.getElementById(`recordingStatus-${exerciseId}`);
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function submitRecording(exerciseId) {
            const studentName = document.getElementById(`studentName-${exerciseId}`).value.trim();
            const studentEmail = document.getElementById(`studentEmail-${exerciseId}`)?.value.trim() || '';
            
            if (!studentName) {
                alert('Please enter your name before submitting.');
                return;
            }
            
            if (!currentRecording || currentRecording.exerciseId !== exerciseId) {
                alert('Please record audio before submitting.');
                return;
            }
            
            const exercise = exercises.find(ex => ex.id === exerciseId);
            const submission = {
                id: Date.now(),
                exerciseId: exerciseId,
                exerciseTitle: exercise.title,
                studentName: studentName,
                studentEmail: studentEmail,
                audioUrl: currentRecording.audioUrl,
                submittedAt: new Date().toISOString(),
                feedback: '',
                rating: ''
            };
            
            submissions.push(submission);
            saveData();
            displaySubmissions();
            displayStats();
            
            // Reset form
            document.getElementById(`studentName-${exerciseId}`).value = '';
            if (document.getElementById(`studentEmail-${exerciseId}`)) {
                document.getElementById(`studentEmail-${exerciseId}`).value = '';
            }
            document.getElementById(`audioPlayer-${exerciseId}`).style.display = 'none';
            document.getElementById(`submitBtn-${exerciseId}`).disabled = true;
            updateRecordingStatus(exerciseId, 'ready', '‚úÖ Submission successful! Your teacher will review your recording.');
            
            currentRecording = null;
        }

        // Display submissions for review
        function displaySubmissions(searchTerm = '', ratingFilter = '') {
            const container = document.getElementById('submissionsList');
            
            let filteredSubmissions = submissions;
            
            if (searchTerm) {
                filteredSubmissions = filteredSubmissions.filter(sub => 
                    sub.studentName.toLowerCase().includes(searchTerm) ||
                    sub.exerciseTitle.toLowerCase().includes(searchTerm)
                );
            }
            
            if (ratingFilter) {
                if (ratingFilter === 'unrated') {
                    filteredSubmissions = filteredSubmissions.filter(sub => !sub.rating);
                } else {
                    filteredSubmissions = filteredSubmissions.filter(sub => sub.rating === ratingFilter);
                }
            }
            
            if (filteredSubmissions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1 / -1;">No submissions found.</p>';
                return;
            }
            
            // Sort by most recent first
            filteredSubmissions.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
            
            container.innerHTML = filteredSubmissions.map(submission => `
                <div class="submission-card">
                    <div class="submission-header">
                        <div class="student-name">${submission.studentName}</div>
                        <div class="timestamp">${new Date(submission.submittedAt).toLocaleString()}</div>
                    </div>
                    
                    <h4>${submission.exerciseTitle}</h4>
                    ${submission.studentEmail ? `<p style="color: #666; font-size: 0.9rem;">üìß ${submission.studentEmail}</p>` : ''}
                    
                    <audio controls class="audio-player">
                        <source src="${submission.audioUrl}" type="audio/wav">
                        Your browser does not support audio playback.
                    </audio>
                    
                    <div class="feedback-form">
                        <div class="rating-group">
                            <label>Rating:</label>
                            <select onchange="updateRating(${submission.id}, this.value)">
                                <option value="">Select rating</option>
                                <option value="excellent" ${submission.rating === 'excellent' ? 'selected' : ''}>‚≠ê Excellent</option>
                                <option value="good" ${submission.rating === 'good' ? 'selected' : ''}>‚úÖ Good</option>
                                <option value="needs-improvement" ${submission.rating === 'needs-improvement' ? 'selected' : ''}>üìù Needs Improvement</option>
                            </select>
                        </div>
                        
                        <textarea placeholder="Provide feedback..." onchange="updateFeedback(${submission.id}, this.value)">${submission.feedback}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateRating(submissionId, rating) {
            const submission = submissions.find(sub => sub.id === submissionId);
            if (submission) {
                submission.rating = rating;
                saveData();
                displayStats();
            }
        }

        function updateFeedback(submissionId, feedback) {
            const submission = submissions.find(sub => sub.id === submissionId);
            if (submission) {
                submission.feedback = feedback;
                saveData();
            }
        }

        // Data persistence with localStorage
        function saveData() {
            const data = {
                exercises: exercises,
                submissions: submissions,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('arabicPronunciationData', JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem('arabicPronunciationData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    exercises = data.exercises || [];
                    submissions = data.submissions || [];
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            } else {
                // Add sample data for first-time users
                exercises = [
                    {
                        id: Date.now(),
                        title: "Basic Greetings",
                        arabicText: "ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá",
                        transliteration: "As-salƒÅmu  øalaykum wa-ra·∏•matu -llƒÅhi wa-barakƒÅtuh",
                        translation: "Peace be upon you and God's mercy and blessings",
                        difficulty: "beginner",
                        createdAt: new Date().toISOString()
                    }
                ];
                saveData();
            }
        }
    </script>
</body>
</html>